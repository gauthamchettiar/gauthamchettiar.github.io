defaults: &defaults
  working_directory: ~/repo
version: 2
jobs:
  build:
    <<: *defaults
    docker:
      - image: starefossen/ruby-node
    environment:
      BUNDLE_PATH: ~/repo/vendor/bundle
    steps:
      - checkout
      - run:
          name: Run Setup
          command:  |
            gem install bundler --conservative
            bundle check || bundle install
            bundle update
            npm install -g yarn
            yarn install --modules-folder ./_assets/yarn
      - run:
          name: Jekyll build
          command: bundle exec jekyll build
      - run:
          name: Deploy to gh-pages
          command: |
            git config credential.helper 'cache --timeout=120'
            git config user.email "gauthamchettiar@gmail.com"
            git config user.name "gauthamchettiar"
            git commit --allow-empty -m "Page release ${CIRCLE_BUILD_NUM} from ${CIRCLE_BRANCH}"
            # Push quietly to prevent showing the token in log
            git push -q --force https://${GITHUB_TOKEN}@github.com/gauthamchettiar/gauthamchettiar.github.io.git ${CIRCLE_BRANCH}:gh-pages
            git tag -a "release_${CIRCLE_BRANCH}_${CIRCLE_BUILD_NUM}" -m "Release based on build ${CIRCLE_BUILD_NUM}"
            git push -q --tags https://${GITHUB_TOKEN}@github.com/gauthamchettiar/gauthamchettiar.github.io.git
      # - run:
      #     name: HTMLProofer tests
      #     command: |
      #       bundle exec htmlproofer ./_site \
      #         --only-4xx \
      #         --allow-hash-href \
      #         --assume-extension \
      #         --check-opengraph \
      #         --url-ignore "feed.xml"
      - persist_to_workspace:
          root: ./
          paths:
            - _site
  # deploy:
  #   machine: true
  #   working_directory: ~/repo
  #   steps:
  #     - run:
  #         name: Deploy build to GitHub Pages
  #         command: |
  #           ls -l
  #           ./bin/deploy
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
defaults: &defaults
  working_directory: ~/repo
version: 2
jobs:
  build:
    <<: *defaults
    docker:
      - image: starefossen/ruby-node
    environment:
      BUNDLE_PATH: ~/repo/vendor/bundle
    steps:
      - checkout
      - run: |
          chown -R $USER:$USER ./bin
          chmod 777 ./bin/*
          ls -l
          ./bin/setup
      - run:
          name: Jekyll build
          command: bundle exec jekyll build
      # - run:
      #     name: HTMLProofer tests
      #     command: |
      #       bundle exec htmlproofer ./_site \
      #         --only-4xx \
      #         --allow-hash-href \
      #         --assume-extension \
      #         --check-opengraph \
      #         --url-ignore "feed.xml"
      - persist_to_workspace:
          root: ./
          paths:
            - _site
  deploy:
    machine: true
    steps:
      - run:
          name: Deploy build to GitHub Pages
          command:
            ./bin/deploy
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master